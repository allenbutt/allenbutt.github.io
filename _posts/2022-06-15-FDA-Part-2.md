---
layout: splash
title: "FDA Medical Device Report Project Part 2 - Text Analysis"
subtitle: "Part 2  Text Analysis"
date: 2022-06-15 00:00:00 -0000
header:
  overlay_image: /assets/images/blue.jpg
  show_overlay_excerpt: false
#background: 
---

# FDA Project - Part 2
## Challenge
We have arrived at a workable dataset, but the most important part for text-analysis is inside the MDR_Text field. Each MDR_Text item is a list of narratives pertaining to the specific malfunction report. We can try to unnest these lists of narratives and keep each narrative separate, but that is not necessary for the scope of this project--instead, what is needed is to remove punctuation and unnecessary/redundant words, so that we have a short string of unique words in each MDR Text field. This will allow for counting of keywords and the compilation of useful visualizations.

An example of one such visualization is shown below. Created in Tableau from output from this code, it shows the progression of keywords of Heartvalve malfunction reports over the past two years.

<iframe src="https://public.tableau.com/views/FDADeviceBarChartRaceHeart/BarChartRaceHeart?:language=en-US&publish=yes&:display_count=n&:origin=viz_share_link:showVizHome=no&:embed=true"
width="1200" height="800"></iframe>


## Code
First we need to cull out unneeded columns and perform some minor data cleaning.

```python
#Keep only relevant columns
dfmain = dfmain[["_device_report_product_code","_brand_name","_generic_name","_manufacturer_d_name","type_of_report","report_number","report_source_code",
                 "date_received","event_type","mdr_text"]]

#Rename columns
dfmain.columns = ["product_code","brand_name","generic_name","manufacturer_name","type_of_report","report_number",
                        "report_source_code","date_received","event_type","mdr_text"]

#Update date column to date format
dfmain["date_received"] = pd.to_datetime(dfmain["date_received"])

#Remove brackets from type of report column
dfmain['type_of_report'] = dfmain['type_of_report'].str.join(', ')

#Update MDR Text to only show the text narrative items--also lowercase the text
newmdr = []
for text_index in dfmain["mdr_text"]:
    newmdr.append(''.join(re.findall("'text': .+?}",str(text_index))).translate(str.maketrans('', '', string.punctuation)).replace("text"," - ")[4:])

dfmain["mdr_text"] = [x.lower() for x in newmdr]
dfmain.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>product_code</th>
      <th>brand_name</th>
      <th>generic_name</th>
      <th>manufacturer_name</th>
      <th>type_of_report</th>
      <th>report_number</th>
      <th>report_source_code</th>
      <th>date_received</th>
      <th>event_type</th>
      <th>mdr_text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>98596</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00003</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>investigation for this complaint is currently ...</td>
    </tr>
    <tr>
      <th>17151</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission</td>
      <td>3004068499-2020-00004</td>
      <td>Manufacturer report</td>
      <td>2020-02-27</td>
      <td>Malfunction</td>
      <td>patient information does not apply the device ...</td>
    </tr>
    <tr>
      <th>42763</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00001</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>investigation for this complaint is currently ...</td>
    </tr>
    <tr>
      <th>70387</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00002</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>investigation for this complaint is currently ...</td>
    </tr>
    <tr>
      <th>20329</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission</td>
      <td>3004068499-2020-00005</td>
      <td>Manufacturer report</td>
      <td>2020-03-20</td>
      <td>Malfunction</td>
      <td>patient information does not apply the device ...</td>
    </tr>
  </tbody>
</table>
</div>


Removal of stop-words and other, common words, is performed here.

```python
#Remove stop words in MDR Text--we must remove null rows before this step can be done
stop_words = set(stopwords.words('english'))

#Add additional common words into stopwords
stop_words.update(["investigation","still","progress","complete","supplemental","report","filed","device","returned","reported",
                  "-","due","failure","failed","may","ensure","assures","around","met","reports","number","per","dated"])

dfmain = dfmain[dfmain['mdr_text'].notnull()]

dfmain['mdr_text'] = dfmain['mdr_text'].apply(lambda x: ' '.join([word for word in x.split() if word not in (stop_words)]))

dfmain.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>product_code</th>
      <th>brand_name</th>
      <th>generic_name</th>
      <th>manufacturer_name</th>
      <th>type_of_report</th>
      <th>report_number</th>
      <th>report_source_code</th>
      <th>date_received</th>
      <th>event_type</th>
      <th>mdr_text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>98596</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00003</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>complaint currently underway yet completed fol...</td>
    </tr>
    <tr>
      <th>17151</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission</td>
      <td>3004068499-2020-00004</td>
      <td>Manufacturer report</td>
      <td>2020-02-27</td>
      <td>Malfunction</td>
      <td>patient information apply patient contact capa...</td>
    </tr>
    <tr>
      <th>42763</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00001</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>complaint currently underway yet completed fol...</td>
    </tr>
    <tr>
      <th>70387</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00002</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>complaint currently underway yet completed fol...</td>
    </tr>
    <tr>
      <th>20329</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission</td>
      <td>3004068499-2020-00005</td>
      <td>Manufacturer report</td>
      <td>2020-03-20</td>
      <td>Malfunction</td>
      <td>patient information apply patient contact outc...</td>
    </tr>
  </tbody>
</table>
</div>


In order to create a bar chart race for keywords, we need to remove all duplicate words from each MDR_Text field.

```python
no_dup = []

#Following function found from internet
def remove_duplicates(input):
 
    # split input string separated by space
    input = input.split(" ")
 
    # now create dictionary using counter method
    # which will have strings as key and their
    # frequencies as value
    UniqW = Counter(input)
 
    # joins two adjacent elements in iterable way
    s = " ".join(UniqW.keys())
    return (s)

dfmain['mdr_text_nodup'] = dfmain['mdr_text'].apply(remove_duplicates)

dfmain['mdr_text_nodup'] = dfmain['mdr_text_nodup'].map(str)

dfmain.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>product_code</th>
      <th>brand_name</th>
      <th>generic_name</th>
      <th>manufacturer_name</th>
      <th>type_of_report</th>
      <th>report_number</th>
      <th>report_source_code</th>
      <th>date_received</th>
      <th>event_type</th>
      <th>mdr_text</th>
      <th>mdr_text_nodup</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>98596</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00003</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>complaint currently underway yet completed fol...</td>
      <td>complaint currently underway yet completed fol...</td>
    </tr>
    <tr>
      <th>17151</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission</td>
      <td>3004068499-2020-00004</td>
      <td>Manufacturer report</td>
      <td>2020-02-27</td>
      <td>Malfunction</td>
      <td>patient information apply patient contact capa...</td>
      <td>patient information apply contact capab4 initi...</td>
    </tr>
    <tr>
      <th>42763</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00001</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>complaint currently underway yet completed fol...</td>
      <td>complaint currently underway yet completed fol...</td>
    </tr>
    <tr>
      <th>70387</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00002</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>complaint currently underway yet completed fol...</td>
      <td>complaint currently underway yet completed fol...</td>
    </tr>
    <tr>
      <th>20329</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission</td>
      <td>3004068499-2020-00005</td>
      <td>Manufacturer report</td>
      <td>2020-03-20</td>
      <td>Malfunction</td>
      <td>patient information apply patient contact outc...</td>
      <td>patient information apply contact outcomes att...</td>
    </tr>
  </tbody>
</table>
</div>


At this point we can run a basic word cloud and see, from the total dataset, what words show up most.

```python
#Implement Word Cloud
word_cloud = WordCloud(collocations = False, background_color = 'white').generate(str(dfmain["mdr_text_nodup"]))
plt.imshow(word_cloud, interpolation='bilinear')
plt.axis("off")
plt.savefig('foo.png')
plt.show()
```


    
![png](/assets/images/fdawordcloud.png)
    



```python
#Create new date field with the days removed, for visualizations

dfmain["year"] = pd.to_datetime(dfmain["date_received"], format = '%Y-%m-%d').dt.year
dfmain["month"] = pd.to_datetime(dfmain["date_received"], format = '%Y-%m-%d').dt.month

dfmain["plaindate"] = pd.to_datetime(dfmain[['year', 'month']].assign(DAY=1))

dfmain = dfmain.drop(["year","month"], 1)

dfmain.head()
```
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>product_code</th>
      <th>brand_name</th>
      <th>generic_name</th>
      <th>manufacturer_name</th>
      <th>type_of_report</th>
      <th>report_number</th>
      <th>report_source_code</th>
      <th>date_received</th>
      <th>event_type</th>
      <th>mdr_text</th>
      <th>mdr_text_nodup</th>
      <th>plaindate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>98596</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00003</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>complaint currently underway yet completed fol...</td>
      <td>complaint currently underway yet completed fol...</td>
      <td>2020-02-01</td>
    </tr>
    <tr>
      <th>17151</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission</td>
      <td>3004068499-2020-00004</td>
      <td>Manufacturer report</td>
      <td>2020-02-27</td>
      <td>Malfunction</td>
      <td>patient information apply patient contact capa...</td>
      <td>patient information apply contact capab4 initi...</td>
      <td>2020-02-01</td>
    </tr>
    <tr>
      <th>42763</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00001</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>complaint currently underway yet completed fol...</td>
      <td>complaint currently underway yet completed fol...</td>
      <td>2020-02-01</td>
    </tr>
    <tr>
      <th>70387</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission, Followup</td>
      <td>3004068499-2020-00002</td>
      <td>Manufacturer report</td>
      <td>2020-02-06</td>
      <td>Malfunction</td>
      <td>complaint currently underway yet completed fol...</td>
      <td>complaint currently underway yet completed fol...</td>
      <td>2020-02-01</td>
    </tr>
    <tr>
      <th>20329</th>
      <td>KDN</td>
      <td>LIFEPORT KIDNEY TRANSPORTER SYSTEM</td>
      <td>PERFUSION CIRCUIT</td>
      <td>ORGAN RECOVERY SYSTEMS, INC.</td>
      <td>Initial submission</td>
      <td>3004068499-2020-00005</td>
      <td>Manufacturer report</td>
      <td>2020-03-20</td>
      <td>Malfunction</td>
      <td>patient information apply patient contact outc...</td>
      <td>patient information apply contact outcomes att...</td>
      <td>2020-03-01</td>
    </tr>
  </tbody>
</table>
</div>

    


```python
#Create new dataframe--list of unique words in data, separated by month

dfmain['mdr_text_nodup'] = dfmain['mdr_text_nodup'].map(str)

dfword = pd.DataFrame()

#Create unique list of dates to be used in the for loop
datelist = dfmain["plaindate"].unique()

#Loop to create dataframe of unique words and the number of times they each appear
wordnumbers = []
for date_index in datelist:
    wordnumbers = Counter(' '.join(map(lambda l: ''.join(l), dfmain.loc[dfmain["plaindate"] == date_index]["mdr_text_nodup"])).split(" ")) 
    dftemp = pd.DataFrame.from_dict(wordnumbers, orient='index').reset_index()
    dftemp["Date"] = date_index
    dfword = pd.concat([dfword, dftemp])
    
dfword.columns = ["word","counts","date"]

dfword.head()
dfword.to_csv(r'word_fda.csv', index = False)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>word</th>
      <th>counts</th>
      <th>date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>complaint</td>
      <td>4</td>
      <td>2020-02-01</td>
    </tr>
    <tr>
      <th>1</th>
      <td>currently</td>
      <td>3</td>
      <td>2020-02-01</td>
    </tr>
    <tr>
      <th>2</th>
      <td>underway</td>
      <td>3</td>
      <td>2020-02-01</td>
    </tr>
    <tr>
      <th>3</th>
      <td>yet</td>
      <td>3</td>
      <td>2020-02-01</td>
    </tr>
    <tr>
      <th>4</th>
      <td>completed</td>
      <td>3</td>
      <td>2020-02-01</td>
    </tr>
  </tbody>
</table>
</div>

The end result is a csv file that can be imported into Tableau and turned into the bar chart race shown at the beginning of this post.